name: Batch

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment"
        required: true
        default: 'v1'
      runs:
        description: "Runs"
        required: true
        default: 10
      maps:
        description: "Maps"
        required: true
        default: "1, 2, 3, 4, 5, 6, 7, 8, 9, 10"

jobs:
  generator:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generator.outputs.matrix }}
    steps:
      - id: generator
        run: |
          echo '::set-output name=matrix::{"run":[${{ github.event.inputs.maps }}]}'

  run:
    needs: generator
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJSON(needs.generator.outputs.matrix)}}
      max-parallel: 19
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Login to registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ secrets.GH_USERNAME }}
          password: ${{ secrets.GH_PAT }}

      - name: Run games
        run: |
          for RUN in ${{ github.event.inputs.runs }}
          do
            echo "Running map ${{ matrix.run }} # $RUN"
          done

  collect:
    needs: run
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "collect"
